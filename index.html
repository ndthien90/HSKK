<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSKK Trung Cấp - AI Master (Fixed)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .chinese-text { font-family: 'Kaiti','Noto Sans SC', sans-serif; }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #64748b; }
        audio { height: 40px; width: 100%; border-radius: 20px; background: #f1f5f9; }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 640px) { .chinese-text { font-size: 1.25rem !important; line-height: 1.75 !important; } }
        
        /* Grade Card Styles */
        .grade-card { transition: all 0.3s ease; }
        .grade-good { border-left: 4px solid #22c55e; }
        .grade-avg { border-left: 4px solid #eab308; }
        .grade-bad { border-left: 4px solid #ef4444; }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background: white; }
            .no-print { display: none !important; }
        }
        
        /* Modal Animation */
        .modal-enter { animation: modal-in 0.3s ease-out forwards; }
        @keyframes modal-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-slate-50">

    <!-- Header -->
    <header class="bg-white shadow-sm z-20 shrink-0 border-b border-gray-100 no-print">
        <div class="max-w-7xl mx-auto px-4 h-14 sm:h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="location.reload()">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-blue-200 shadow-lg group-hover:scale-105 transition-transform">
                    <i class="fa-solid fa-dragon text-lg sm:text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg sm:text-xl font-bold text-gray-900 tracking-tight leading-none">HSKK MASTER</h1>
                    <span class="text-[10px] sm:text-xs font-semibold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded" id="env-badge">Auto Detect</span>
                </div>
            </div>
            <div id="user-badge" class="flex items-center gap-3">
                <button onclick="App.importJSON()" class="hidden sm:flex items-center gap-2 text-xs font-bold text-gray-500 hover:text-blue-600 bg-gray-50 hover:bg-blue-50 px-3 py-1.5 rounded-lg transition-colors border border-gray-200">
                    <i class="fa-solid fa-file-import"></i> Nhập JSON
                </button>
                <div class="hidden sm:flex text-right flex-col">
                    <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Source</span>
                    <span class="text-xs font-bold text-green-600" id="storage-label"><i class="fa-solid fa-database mr-1"></i>Checking...</span>
                </div>
                <div class="w-8 h-8 sm:w-9 sm:h-9 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center text-gray-600 shadow-inner">
                    <i class="fa-solid fa-user-graduate"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden p-3 sm:p-4 md:p-6 scroll-smooth" id="app-container">
        <div class="flex h-full items-center justify-center">
            <div class="loader"></div>
        </div>
    </main>

    <!-- Footer Control Bar -->
    <footer class="bg-white border-t border-gray-200 p-3 sm:p-4 hidden z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] no-print" id="control-bar">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <button id="btn-prev" class="invisible px-3 sm:px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 text-sm sm:text-base transition-colors">
                <i class="fa-solid fa-chevron-left mr-1 sm:mr-2"></i> <span class="hidden sm:inline">Trước</span>
            </button>
            <div class="flex gap-2" id="action-buttons"></div>
            <button id="btn-next" class="px-5 sm:px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all flex items-center text-sm sm:text-base font-bold active:scale-95">
                Tiếp theo <i class="fa-solid fa-chevron-right ml-2"></i>
            </button>
        </div>
    </footer>

    <!-- AI Modal -->
    <div id="ai-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4 no-print">
        <!-- AI Loading View -->
        <div id="ai-loading-view" class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center hidden">
            <div class="relative w-24 h-24 mx-auto mb-6">
                <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
                <i class="fa-solid fa-brain absolute inset-0 flex items-center justify-center text-3xl text-blue-500 animate-pulse"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Đang kết nối Gemini AI...</h3>
            <p id="ai-status-text" class="text-sm text-gray-500">Đang khởi tạo session...</p>
        </div>

        <!-- AI Editor View -->
        <div id="ai-editor-view" class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col hidden overflow-hidden">
            <div class="bg-gradient-to-r from-slate-900 to-slate-800 p-4 shrink-0 flex justify-between items-center border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/5 rounded-lg flex items-center justify-center text-white border border-white/10"><i class="fa-solid fa-microchip text-xl text-blue-400"></i></div>
                    <div>
                        <h3 class="text-white font-bold text-lg leading-tight" id="ai-editor-title">AI Exam Architect</h3>
                        <p class="text-slate-400 text-xs">Powered by Google Gemini & Imagen (Auto-Compress)</p>
                    </div>
                </div>
                <button onclick="App.closeAIModal()" class="text-slate-400 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-8 bg-slate-50" id="ai-editor-content">
                <!-- Dynamic Content Form -->
            </div>

            <div class="p-4 border-t border-gray-200 bg-white flex justify-end gap-3 shrink-0">
                <button onclick="App.saveAIExam()" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-lg transform active:scale-95 transition flex items-center text-sm sm:text-base">
                    <i class="fa-solid fa-save mr-2"></i>Lưu Đề Thi
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="delete-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full modal-enter text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                <i class="fa-solid fa-trash-can text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Xóa đề thi này?</h3>
            <p class="text-sm text-gray-500 mb-6">Hành động này không thể hoàn tác. Bạn có chắc chắn muốn xóa?</p>
            <div class="flex gap-3">
                <button onclick="document.getElementById('delete-modal').classList.add('hidden')" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition">Hủy</button>
                <button id="btn-confirm-delete" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 shadow-lg shadow-red-200 transition">Xóa ngay</button>
            </div>
        </div>
    </div>

    <!-- Edit Exam Modal -->
    <div id="edit-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full modal-enter">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Chỉnh sửa thông tin</h3>
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên đề thi</label>
                    <input type="text" id="edit-exam-title" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nhập tên mới...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mã đề (ID)</label>
                    <input type="text" id="edit-exam-id" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 font-mono text-sm">
                    <p class="text-[10px] text-gray-400 mt-1 italic">*Thay đổi ID sẽ tạo bản sao mới.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg transition">Hủy</button>
                <button id="btn-save-edit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <!-- Print Options Modal -->
    <div id="print-options-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full modal-enter text-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500">
                <i class="fa-solid fa-print text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Tùy chọn in ấn</h3>
            <p class="text-sm text-gray-500 mb-6">Bạn muốn in nội dung nào?</p>
            <div class="flex flex-col gap-3">
                <button id="btn-print-questions" class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition flex items-center justify-center gap-2">
                    <i class="fa-regular fa-file"></i> Chỉ in đề thi
                </button>
                <button id="btn-print-full" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-circle-check"></i> In kèm đáp án mẫu
                </button>
                <button onclick="document.getElementById('print-options-modal').classList.add('hidden')" class="mt-2 text-sm text-gray-400 hover:text-gray-600">Hủy bỏ</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area" class="hidden"></div>

    <!-- TEMPLATES -->
    <template id="tpl-dashboard">
        <div class="max-w-5xl mx-auto mt-4 sm:mt-10 pb-10 px-4">
            <div class="text-center mb-8 sm:mb-12">
                <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-3 sm:mb-4 tracking-tight">Hệ thống luyện thi HSKK</h2>
                <p class="text-gray-600 max-w-2xl mx-auto text-sm sm:text-base">Tạo đề thi, lưu trữ cục bộ và <span class="text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded">xuất bản tài liệu</span> dễ dàng.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6" id="exam-list">
                <!-- Create New Card -->
                <div id="create-new-card" onclick="App.openAICreator()" class="group relative bg-white rounded-2xl p-1 shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer hover:-translate-y-1">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 -z-10 blur-sm"></div>
                    <div class="bg-white h-full rounded-xl p-6 flex flex-col items-center justify-center text-center relative overflow-hidden border border-gray-100 group-hover:border-transparent">
                        <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300 text-blue-600">
                            <i class="fa-solid fa-wand-magic-sparkles text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Tạo Đề AI Mới</h3>
                        <p class="text-sm text-gray-500 mb-4">Tùy chỉnh chủ đề, tự động lưu vào trình duyệt.</p>
                        <span class="inline-flex items-center text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full"><i class="fa-solid fa-plus mr-1"></i> Bắt đầu</span>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-part-intro">
        <div class="flex flex-col items-center justify-center h-full text-center space-y-6 px-6 animate-fade-in">
            <div class="w-24 h-24 sm:w-32 sm:h-32 bg-white rounded-full flex items-center justify-center text-blue-600 text-4xl sm:text-5xl shadow-xl mb-4 border-4 border-blue-50"><i class="part-icon fa-solid"></i></div>
            <div class="space-y-2">
                <h2 class="text-2xl sm:text-3xl font-bold part-title text-gray-800"></h2>
                <div class="h-1 w-16 bg-blue-500 mx-auto rounded-full"></div>
            </div>
            <p class="text-gray-600 max-w-md part-desc text-base sm:text-lg leading-relaxed"></p>
            <button class="btn-start-part mt-8 px-10 py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 hover:shadow-blue-300 transform transition-all hover:-translate-y-1 active:scale-95 flex items-center">
                <span>Bắt đầu phần này</span>
                <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </template>

    <template id="tpl-part-1">
        <div class="max-w-2xl mx-auto h-full flex flex-col justify-center pb-10 px-4">
            <div class="bg-white rounded-3xl shadow-xl shadow-gray-200/50 p-6 sm:p-10 text-center relative overflow-hidden border border-gray-100">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gray-100"><div id="p1-progress" class="h-full bg-blue-500 transition-all duration-300 rounded-r-full" style="width: 0%"></div></div>
                <div class="mb-8 mt-4 flex justify-between items-center px-2">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">HSKK Intermediate</span>
                    <span class="text-sm font-bold bg-blue-50 text-blue-600 px-3 py-1 rounded-full border border-blue-100">Câu <span id="p1-current-index" class="text-lg">1</span>/10</span>
                </div>
                <div class="min-h-[240px] flex items-center justify-center">
                    <div id="p1-state-listen" class="py-4">
                        <div class="w-24 h-24 sm:w-32 sm:h-32 mx-auto bg-blue-50 rounded-full flex items-center justify-center mb-6 animate-pulse ring-8 ring-blue-50/50">
                            <i class="fa-solid fa-headphones text-4xl sm:text-5xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800">Đang phát câu mẫu...</h3>
                    </div>
                    <div id="p1-state-wait" class="py-4 hidden">
                        <div class="w-24 h-24 sm:w-32 sm:h-32 mx-auto bg-yellow-50 rounded-full flex items-center justify-center mb-6 ring-8 ring-yellow-50/50">
                            <span class="text-5xl sm:text-6xl font-black text-yellow-500" id="p1-countdown">3</span>
                        </div>
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800">Chuẩn bị...</h3>
                    </div>
                    <div id="p1-state-record" class="py-4 hidden">
                        <div class="w-24 h-24 sm:w-32 sm:h-32 mx-auto bg-red-50 rounded-full flex items-center justify-center mb-6 recording-pulse border-4 border-red-100">
                            <i class="fa-solid fa-microphone text-4xl sm:text-5xl text-red-500"></i>
                        </div>
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 text-red-600">Đang Ghi Âm</h3>
                    </div>
                </div>
                <div id="p1-status-msg" class="mt-6 text-sm text-gray-400 min-h-[20px] font-medium italic"></div>
            </div>
        </div>
    </template>

    <template id="tpl-visual-qa">
        <div class="max-w-7xl mx-auto flex flex-col lg:grid lg:grid-cols-2 gap-6 lg:gap-8 pb-24 px-4 h-full">
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 flex flex-col order-1 border border-gray-100 h-full">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold part-number-badge">1</span>
                        <h3 class="font-bold text-gray-700 uppercase tracking-wide part-label text-sm sm:text-base"></h3>
                    </div>
                    <button class="btn-toggle-hint text-amber-500 text-xs sm:text-sm hover:text-amber-600 font-bold bg-amber-50 px-3 py-1.5 rounded-full transition-colors"><i class="fa-regular fa-lightbulb mr-1"></i> Gợi ý</button>
                </div>
                <div id="stimulus-container" class="flex-1 flex items-center justify-center bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 min-h-[220px] relative mb-4 p-4 overflow-hidden group"></div>
                <div class="mt-auto pt-4 border-t border-gray-100">
                    <div id="recording-ui" class="bg-gray-50 rounded-xl p-4 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-xs sm:text-sm font-bold text-gray-500 uppercase">Thời gian trả lời</span>
                            <span id="recording-timer" class="font-mono font-bold text-gray-800 text-xl">00:00</span>
                        </div>
                        <div class="flex items-center justify-center gap-6">
                            <button id="btn-record-toggle" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-200 flex items-center justify-center transition-all transform active:scale-95 ring-4 ring-white border-4 border-red-100">
                                <i class="fa-solid fa-microphone text-2xl sm:text-3xl"></i>
                            </button>
                        </div>
                    </div>
                    <div id="playback-ui" class="hidden bg-blue-50 rounded-xl p-4 border border-blue-100">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-bold text-blue-700 flex items-center"><i class="fa-solid fa-circle-check mr-2 text-green-500"></i> Đã thu âm xong</span>
                            <button id="btn-rerecord" class="text-xs text-red-500 hover:text-red-700 font-bold px-3 py-1.5 hover:bg-white rounded-lg transition-all border border-transparent hover:border-red-200"><i class="fa-solid fa-rotate-left mr-1"></i>Thu lại</button>
                        </div>
                        <audio id="user-playback-audio" controls class="w-full shadow-sm"></audio>
                    </div>
                </div>
            </div>
            <div id="answer-panel" class="bg-white rounded-2xl shadow-lg flex flex-col h-auto min-h-[400px] lg:h-full opacity-50 pointer-events-none transition-all duration-300 filter blur-sm order-2 mb-20 lg:mb-0 border border-gray-100">
                <div class="bg-gray-50 px-4 sm:px-6 py-3 border-b border-gray-200 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
                    <div class="flex gap-2 p-1 bg-gray-200/50 rounded-lg">
                        <button class="tab-btn tab-active px-4 py-1.5 rounded-md text-sm transition-all" data-tab="hanzi">Chữ Hán</button>
                        <button class="tab-btn tab-inactive px-4 py-1.5 rounded-md text-sm transition-all hover:bg-white/50" data-tab="pinyin">Pinyin</button>
                        <button class="tab-btn tab-inactive px-4 py-1.5 rounded-md text-sm transition-all hover:bg-white/50" data-tab="meaning">Nghĩa</button>
                    </div>
                    <button id="btn-speak-sample" class="text-blue-500 hover:text-blue-700 w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm hover:shadow active:scale-95 transition-all"><i class="fa-solid fa-volume-high"></i></button>
                </div>
                <div class="p-6 flex-1 overflow-y-auto max-h-[50vh] lg:max-h-full">
                    <div id="tab-hanzi" class="tab-content text-2xl leading-loose text-gray-800 chinese-text text-justify whitespace-pre-wrap font-medium"></div>
                    <div id="tab-pinyin" class="tab-content hidden text-lg leading-loose text-blue-600 font-mono text-justify whitespace-pre-wrap"></div>
                    <div id="tab-meaning" class="tab-content hidden text-base leading-relaxed text-gray-700 italic text-justify whitespace-pre-wrap bg-yellow-50 p-4 rounded-lg border border-yellow-100"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-review">
        <div class="max-w-4xl mx-auto pb-24 px-4 sm:px-6">
            <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 mb-8 mt-6 text-center border border-blue-100">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
                    <i class="fa-solid fa-flag-checkered text-3xl"></i>
                </div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Hoàn thành bài thi!</h2>
                <div class="mt-6 grid grid-cols-2 gap-4 max-w-sm mx-auto">
                    <button onclick="location.reload()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-bold text-sm transition"><i class="fa-solid fa-house mr-2"></i>Về trang chủ</button>
                </div>
            </div>

            <!-- NEW: Grade All Button -->
            <div class="flex justify-center mb-8">
                <button onclick="App.gradeAll()" id="btn-grade-all" class="px-8 py-4 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold shadow-lg shadow-purple-200 transition-all transform active:scale-95 flex items-center text-lg">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Chấm điểm tất cả (AI)
                </button>
            </div>

            <div class="space-y-10">
                <div id="review-part-1">
                    <div class="flex items-center gap-3 mb-6 sticky top-0 bg-slate-50 py-3 z-10 border-b border-gray-200">
                        <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold shadow-lg shadow-blue-200">1</div>
                        <h3 class="text-xl font-bold text-gray-800">Nghe nhắc lại</h3>
                    </div>
                    <div id="review-p1-list" class="space-y-6"></div>
                </div>
                <div id="review-part-2">
                    <div class="flex items-center gap-3 mb-6 sticky top-0 bg-slate-50 py-3 z-10 border-b border-gray-200">
                        <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold shadow-lg shadow-blue-200">2</div>
                        <h3 class="text-xl font-bold text-gray-800">Mô tả tranh</h3>
                    </div>
                    <div id="review-p2-list" class="space-y-8"></div>
                </div>
                <div id="review-part-3">
                    <div class="flex items-center gap-3 mb-6 sticky top-0 bg-slate-50 py-3 z-10 border-b border-gray-200">
                        <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold shadow-lg shadow-blue-200">3</div>
                        <h3 class="text-xl font-bold text-gray-800">Trả lời câu hỏi</h3>
                    </div>
                    <div id="review-p3-list" class="space-y-8"></div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- REAL AI SERVICE (GEMINI & IMAGEN) ---
        const apiKey = ""; 
        const AI_SERVICE = {
            cleanAndParseJSON(text) {
                if (!text) return null;
                const cleanText = text.replace(/```json\n?|```/g, '').trim();
                try { return JSON.parse(cleanText); } 
                catch (e) { console.error("JSON Parse Error:", e, text); return null; }
            },
            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => { resolve(reader.result.split(',')[1]); };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            },
            async compressImage(base64Str, maxWidth = 400, quality = 0.6) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64Str.startsWith('data:') ? base64Str : `data:image/png;base64,${base64Str}`;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, width, height); ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = () => resolve(base64Str);
                });
            },
            async generateText(prompt) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                try {
                    const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    const data = await response.json();
                    return this.cleanAndParseJSON(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { return null; }
            },
            async evaluateAudio(audioBlob, contextInfo) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const base64Audio = await this.blobToBase64(audioBlob);
                let contextPrompt = contextInfo.type === 'p1' ? `Nhắc lại câu: "${contextInfo.referenceText}".` : 
                                   (contextInfo.type === 'p2' ? `Mô tả tranh. Tham khảo: "${contextInfo.referenceText}".` : `Trả lời câu hỏi: "${contextInfo.question}".`);
                const systemPrompt = `Bạn là giám khảo HSKK. Nghe và đánh giá. ${contextPrompt} JSON Output: { "score": 0-100, "comment": "Tiếng Việt", "errors": [{ "type": "", "desc": "" }], "correction": "Tiếng Trung + Pinyin" }`;
                const payload = { contents: [{ parts: [{ text: systemPrompt }, { inlineData: { mimeType: "audio/wav", data: base64Audio } }] }], generationConfig: { responseMimeType: "application/json" } };
                try {
                    const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    const data = await response.json();
                    return this.cleanAndParseJSON(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { return { score: 0, comment: "Lỗi AI", errors: [], correction: "" }; }
            },
            async generateImage(prompt) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                const payload = { instances: [{ prompt: "Realistic, " + prompt }], parameters: { sampleCount: 1 } };
                try {
                    const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(response.status);
                    const data = await response.json();
                    const raw = data.predictions?.[0]?.bytesBase64Encoded;
                    return raw ? await this.compressImage(raw) : null;
                } catch (e) { return "https://images.unsplash.com/photo-1556910103-1c02745a30bf?w=600"; }
            },
            async generateP1(userPrompt) {
                const topic = userPrompt || "cuộc sống hàng ngày";
                const prompt = `Bạn là giáo viên HSKK. Hãy tạo 10 câu tiếng Trung ， mỗi câu gồm 10 từ(trình độ HSK4) để luyện nghe nhắc lại. Chủ đề: ${topic}. Output Format (JSON Array of strings): ["Câu 1", "Câu 2", ...]`;
                let res = await this.generateText(prompt); if (!res || !Array.isArray(res)) res = await this.generateText(prompt);
                return Array.isArray(res) ? res : ["Lỗi tạo câu hỏi. Vui lòng thử lại sau."];
            },
            async generateP2Essay(imageDesc, style, extraReq = "") {
                const styleDesc = style === 'roleplay' ? "nhập vai nhân vật trong ảnh (dùng 'tôi')" : "người thứ 3 miêu tả khách quan";
                const prompt = `Bạn là giáo viên HSKK. Viết đoạn văn miêu tả bức ảnh: "${imageDesc}" dài khoảng 300 từ. Phong cách: ${styleDesc}. ${extraReq} Yêu cầu chung: Tiếng Trung, Pinyin, Nghĩa. Output Format (JSON Object): { "hanzi": "...", "pinyin": "...", "meaning": "..." }`;
                let res = await this.generateText(prompt); if (!res) res = await this.generateText(prompt);
                return res ? `${res.hanzi}#${res.pinyin}#${res.meaning}` : "Đang tải...#Loading...#Đang tải...";
            },
            async generateP3Essay(question, extraReq = "") {
                const reqDesc = extraReq ? `Yêu cầu bổ sung của người dùng (TUÂN THỦ NGHIÊM NGẶT): ${extraReq}` : "Độ dài tiêu chuẩn khoảng 300 chữ.";
                
                const prompt = `Bạn là giáo viên HSKK. Hãy viết bài trả lời mẫu cho câu hỏi nghị luận: "${question}".
                ${reqDesc}
                Cấu trúc BẮT BUỘC:
                1. Mở đầu: "各位老师上午好，题目我已收到，现在我开始回答第三部分的第...个问题。问题是..."
                2. Thân bài: Dùng "第一，第二，第三..." hoặc "首先，其次...".
                3. Kết thúc: "我的回答已完毕，谢谢各位老师的聆听！"
                Output Format (JSON Object): { "hanzi": "chữ Hán...", "pinyin": "pinyin...", "meaning": "nghĩa tiếng Việt..." }`;
                
                let res = await this.generateText(prompt);
                if (!res) res = await this.generateText(prompt);
                return res ? `${res.hanzi}#${res.pinyin}#${res.meaning}` : "Đang tải...#Loading...#Đang tải...";
            }
        };

        // --- FILESYSTEM & LOCAL STORAGE ---
        const MOCK_DATA = {};
        const STORAGE_KEY = 'hskk_exams_data_v2';

        class MockFileSystem {
            static init() {
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) Object.assign(MOCK_DATA, JSON.parse(stored));
                } catch (e) { console.error("Load storage failed", e); }
            }
            static save() {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(MOCK_DATA)); } 
                catch (e) { if(e.name === 'QuotaExceededError') alert("Bộ nhớ trình duyệt đầy!"); }
            }
            static getFile(path) {
                const parts = path.split('/'); if(parts.length < 3) return null;
                return MOCK_DATA[parts[1]]?.[parts[2]] || null;
            }
            static getExamSets() { return Object.keys(MOCK_DATA).sort().reverse(); }
            static addExam(id, data) { MOCK_DATA[id] = data; this.save(); }
            static deleteExam(id) { if(MOCK_DATA[id]) { delete MOCK_DATA[id]; this.save(); return true; } return false; }
            static updateExam(oldId, newId, newTitle) {
                if (!MOCK_DATA[oldId]) return false;
                const data = MOCK_DATA[oldId]; data.title = newTitle;
                if (oldId !== newId) { if(MOCK_DATA[newId]) return false; MOCK_DATA[newId] = data; delete MOCK_DATA[oldId]; } 
                else MOCK_DATA[oldId] = data;
                this.save(); return true;
            }
            static getFullExamData(id) { return MOCK_DATA[id]; }
        }
        
        const AudioEngine = {
            synth: window.speechSynthesis, voices: [],
            init() { this.loadVoices(); if(speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = this.loadVoices.bind(this); },
            loadVoices() { this.voices = this.synth.getVoices(); },
            speak(text, lang = 'zh-CN', onEnd) {
                if (this.synth.speaking) this.synth.cancel();
                const utterThis = new SpeechSynthesisUtterance(text);
                const zhVoice = this.voices.find(v => v.lang.includes('zh') || v.lang.includes('CN'));
                if (zhVoice) utterThis.voice = zhVoice;
                utterThis.lang = lang; utterThis.rate = 0.9; if (onEnd) utterThis.onend = onEnd;
                this.synth.speak(utterThis);
            },
            playTing() {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator(); const g = ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(1000, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.1);
                g.gain.setValueAtTime(0.5, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.connect(g); g.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.5);
            }
        };
        AudioEngine.init();

        // --- APP LOGIC ---
        const App = {
            state: {
                currentExam: null,
                p1Data: [], p1Index: 0,
                p2Data: [], p2Index: 0,
                p3Data: [], p3Index: 0,
                userRecordings: { p1: [], p2: [], p3: [] },
                mediaRecorder: null, audioChunks: [],
                tempAIExam: null,
                targetDeleteId: null, targetEditId: null, editingExamId: null,
                targetPrintId: null,
                isExternal: false,
                completedExams: new Set()
            },
            
            async init() {
                const completed = localStorage.getItem('hskk_completed_exams');
                if(completed) this.state.completedExams = new Set(JSON.parse(completed));
                await this.checkEnvironment();
            },

            async checkEnvironment() {
                const envBadge = document.getElementById('env-badge');
                const storageLabel = document.getElementById('storage-label');
                try {
                    const response = await fetch('data_HSKK/index.json');
                    if (response.ok) {
                        const fileList = await response.json();
                        this.state.isExternal = true;
                        envBadge.innerText = "Offline Reader Mode";
                        envBadge.classList.replace('bg-blue-50', 'bg-purple-100');
                        envBadge.classList.replace('text-blue-600', 'text-purple-700');
                        storageLabel.innerHTML = '<i class="fa-solid fa-folder-open mr-1"></i>Local Data';
                        for (const key in MOCK_DATA) delete MOCK_DATA[key];
                        await this.loadExternalData(fileList);
                    } else { throw new Error("No local data"); }
                } catch (e) {
                    this.state.isExternal = false;
                    envBadge.innerText = "Canvas Creator Mode";
                    storageLabel.innerHTML = '<i class="fa-solid fa-database mr-1"></i>Browser';
                    MockFileSystem.init();
                    this.renderDashboard();
                }
            },

            async loadExternalData(fileList) {
                const promises = fileList.map(async (filename) => {
                    try {
                        const res = await fetch(`data_HSKK/${filename}`);
                        if(res.ok) {
                            const data = await res.json();
                            const id = filename.replace('.json', '');
                            MOCK_DATA[id] = data;
                        }
                    } catch(e) { console.error(`Failed to load ${filename}`, e); }
                });
                await Promise.all(promises);
                this.renderDashboard();
            },
            
            resetExamState() { this.state.p1Index=0; this.state.p2Index=0; this.state.p3Index=0; this.state.userRecordings={p1:[],p2:[],p3:[]}; },
            loadExamData(examId) {
                this.state.currentExam = examId;
                const p1Raw = MockFileSystem.getFile(`data_HSKK/${examId}/p1.txt`);
                this.state.p1Data = p1Raw ? p1Raw.split('\n').filter(l => l.trim() !== '') : [];
                this.state.p2Data = [1, 2].map(i => {
                    const img = MockFileSystem.getFile(`data_HSKK/${examId}/img${i}.png`);
                    const txt = MockFileSystem.getFile(`data_HSKK/${examId}/P2_${i}.txt`);
                    const [hanzi, pinyin, meaning] = txt ? txt.split('#') : ["","",""];
                    return { id: i, img, hanzi, pinyin, meaning };
                });
                this.state.p3Data = [1, 2].map(i => {
                    const txt = MockFileSystem.getFile(`data_HSKK/${examId}/p3_${i}.txt`);
                    const parts = txt ? txt.split('#') : ["","","",""];
                    return { id: i, question: parts[0], hanzi: parts[1], pinyin: parts[2], meaning: parts[3] };
                });
            },

            exportWord(examId, event) {
                event.stopPropagation();
                this.loadExamData(examId);
                const p1Rows = this.state.p1Data.map((s,i) => `<p><b>Câu ${i+1}:</b> ${s}</p>`).join('');
                const p2Rows = this.state.p2Data.map((d,i) => `
                    <div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 10px;">
                        <h3>Hình ${i+1}</h3>${d.img ? `<img src="${d.img}" width="189" height="189">` : ''}
                        <p><b>Văn mẫu:</b> ${d.hanzi}</p><p style="color:#0055cc"><i>${d.pinyin}</i></p><p><i>${d.meaning}</i></p>
                    </div>`).join('');
                const p3Rows = this.state.p3Data.map((d,i) => `
                    <div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 10px;">
                        <h3>Câu hỏi ${i+1}: ${d.question}</h3><p><b>Trả lời mẫu:</b> ${d.hanzi}</p><p style="color:#0055cc"><i>${d.pinyin}</i></p><p><i>${d.meaning}</i></p>
                    </div>`).join('');
                const content = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>HSKK Exam ${examId}</title>
                    <style>@page{size:21cm 29.7cm;margin:2cm 2cm 2cm 3cm;mso-page-orientation:portrait;}body{font-family:'Times New Roman',serif;}img{width:5cm;height:5cm;object-fit:cover;}</style></head>
                    <body style="padding:0;"><h1 style="text-align:center;color:#333;">ĐỀ THI THỬ HSKK TRUNG CẤP</h1><h2 style="color:#2b6cb0;">Phần 1: Nghe nhắc lại</h2>${p1Rows}<hr><h2 style="color:#2b6cb0;">Phần 2: Mô tả tranh</h2>${p2Rows}<hr><h2 style="color:#2b6cb0;">Phần 3: Trả lời câu hỏi</h2>${p3Rows}</body></html>`;
                const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `HSKK_Exam_${examId}.doc`; link.click();
            },
            exportTxt(examId, event) {
                event.stopPropagation();
                this.loadExamData(examId);
                let txt = `[P1]\n` + this.state.p1Data.join('\n') + '\n';
                this.state.p2Data.forEach(d => { txt += `[P2-${d.id}]\n${d.hanzi}\n${d.pinyin}\n${d.meaning}\n`; });
                this.state.p3Data.forEach(d => { txt += `[P3-${d.id+1}]\n${d.hanzi}\n${d.pinyin}\n${d.meaning}\n`; });
                const blob = new Blob([txt], { type: 'text/plain' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `HSKK_Exam_${examId}.txt`; link.click();
            },
            exportJson(examId, event) {
                event.stopPropagation();
                const data = MockFileSystem.getFullExamData(examId);
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `HSKK_Data_${examId}.json`; link.click();
            },
            importJSON() {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (!data || (typeof data !== 'object')) throw new Error("Invalid JSON structure");
                            const newId = `import_${Date.now()}`;
                            MockFileSystem.addExam(newId, data);
                            alert("Nhập dữ liệu thành công!");
                            this.renderDashboard();
                        } catch(err) { 
                            console.error(err);
                            alert("Lỗi: File JSON không hợp lệ hoặc cấu trúc sai."); 
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            printExam(examId, event) {
                event.stopPropagation();
                this.state.targetPrintId = examId;
                document.getElementById('print-options-modal').classList.remove('hidden');
                const btnQuestions = document.getElementById('btn-print-questions');
                const btnFull = document.getElementById('btn-print-full');
                const newBtnQ = btnQuestions.cloneNode(true);
                const newBtnF = btnFull.cloneNode(true);
                btnQuestions.parentNode.replaceChild(newBtnQ, btnQuestions);
                btnFull.parentNode.replaceChild(newBtnF, btnFull);
                newBtnQ.onclick = () => { this.doPrint(this.state.targetPrintId, false); document.getElementById('print-options-modal').classList.add('hidden'); };
                newBtnF.onclick = () => { this.doPrint(this.state.targetPrintId, true); document.getElementById('print-options-modal').classList.add('hidden'); };
            },

            doPrint(examId, withAnswers) {
                this.loadExamData(examId);
                const p1Content = withAnswers ? `<ol class="chinese-font" style="line-height: 1.3;">${this.state.p1Data.map(s => `<li>${s}</li>`).join('')}</ol>` : `<p style="margin-left: 20px; font-style: italic;">(Thí sinh nghe ghi âm và nhắc lại)</p>`;
                const p2Content = this.state.p2Data.map((d, i) => `<div class="q-box clearfix"><strong>Hình ${i+1}:</strong><div style="margin-top: 10px;">${d.img ? `<img src="${d.img}">` : ''}${withAnswers ? `<div class="p-box"><p class="chinese-font" style="font-size: 14pt;">${d.hanzi}</p><p style="font-style: italic; color: #444;">${d.pinyin}</p><p>${d.meaning}</p></div>` : ''}</div></div>`).join('');
                const p3Content = this.state.p3Data.map((d, i) => `<div class="q-box clearfix"><strong>Câu ${i+1}: ${d.question}</strong>${withAnswers ? `<div class="p-box" style="margin-top: 10px;"><p class="chinese-font" style="font-size: 14pt;">${d.hanzi}</p><p style="color: #444;">${d.pinyin}</p><p>${d.meaning}</p></div>` : `<div></div>`}</div>`).join('');
                const printContent = `<html><head><title>In Đề Thi - ${examId}</title><style>body { font-family:  'Mulish', 'Times New Roman', serif; max-width: 210mm; margin: 0 auto; padding: 10mm; font-size: 14pt; line-height: 1.5; } @media print { body { padding: 0; } .no-print { display: none; } } h1 { text-align: center; font-size: 20pt; border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 20px; } h2 { margin-top: 20px; font-size: 16pt; margin-bottom: 10px; padding-bottom: 5px; } img { width: 5cm; height: 5cm; object-fit: cover; border: 1px solid #000; float: left; margin-right: 15px; margin-bottom: 10px; } .q-box { margin-bottom: 15px; clear: both; } .p-box { text-align: justify; } ul, ol { margin-top: 5px; margin-bottom: 5px; } p { margin: 5px 0; } .chinese-font { font-family: "Kaiti","SimSun", "Noto Sans SC", serif; font-size: 16pt} .clearfix::after { content: ""; clear: both; display: table; } .btn-print { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: blue; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; } </style></head><body><button class="btn-print no-print" onclick="window.print()">🖨️ In ngay</button><h1>ĐỀ MÔ PHỎNG HSKK TRUNG CẤP<br><span style="font-size: 14pt; font-weight: normal;">ID: ${examId}</span></h1><h2>PHẦN 1: Nghe và nhắc lại (听后重复)</h2>${p1Content}<h2>PHẦN 2: Mô tả tranh cho trước(看图说话)</h2>${p2Content}<h2>PHẦN 3: Trả lời câu hỏi nghị luận(回答问题)</h2>${p3Content}</body></html>`;
                const printWindow = window.open('', '_blank');
                if (printWindow) { printWindow.document.write(printContent); printWindow.document.close(); } else { alert("Vui lòng cho phép mở cửa sổ mới (Pop-up) để in!"); }
            },

            confirmDelete(examId, event) {
                event.stopPropagation();
                this.state.targetDeleteId = examId;
                document.getElementById('delete-modal').classList.remove('hidden');
                document.getElementById('btn-confirm-delete').onclick = () => { MockFileSystem.deleteExam(this.state.targetDeleteId); document.getElementById('delete-modal').classList.add('hidden'); this.renderDashboard(); };
            },
            openEditModal(examId, event) {
                event.stopPropagation();
                this.state.targetEditId = examId;
                const data = MockFileSystem.getFullExamData(examId);
                const title = data.title || examId;
                document.getElementById('edit-exam-title').value = title;
                document.getElementById('edit-exam-id').value = examId;
                document.getElementById('edit-modal').classList.remove('hidden');
                document.getElementById('btn-save-edit').onclick = () => {
                    const newTitle = document.getElementById('edit-exam-title').value;
                    const newId = document.getElementById('edit-exam-id').value;
                    if(!newId) return alert("ID không được để trống!");
                    const success = MockFileSystem.updateExam(this.state.targetEditId, newId, newTitle);
                    if(success) { document.getElementById('edit-modal').classList.add('hidden'); this.renderDashboard(); } else { alert("ID mới đã tồn tại hoặc có lỗi!"); }
                };
            },
            editExamContent(examId, event) {
                if(event) event.stopPropagation();
                const data = MockFileSystem.getFullExamData(examId);
                if(!data) return;
                this.state.editingExamId = examId;
                let meta = { p1Prompt: "", p2: [{prompt:"",req:""}, {prompt:"",req:""}], p3: [{req:""}, {req:""}] };
                if (data["metadata.json"]) { try { meta = JSON.parse(data["metadata.json"]); } catch(e) {} }
                this.state.tempAIExam = {
                    p1: data["p1.txt"] ? data["p1.txt"].split('\n') : [],
                    p2: [1, 2].map((id, i) => ({ img: data[`img${id}.png`]||"", text1: data[`P2_${id}.txt`]||"", userPrompt: meta.p2[i].prompt||"", req: meta.p2[i].req||"" })),
                    p3: [1, 2].map((id, i) => { const raw = data[`p3_${id}.txt`]||"#"; const parts = raw.split('#'); return { q: parts[0]||"", a: parts.slice(1).join('#'), req: meta.p3[i].req||"" }; })
                };
                const modal = document.getElementById('ai-modal');
                document.getElementById('ai-loading-view').classList.add('hidden');
                document.getElementById('ai-editor-view').classList.remove('hidden');
                document.getElementById('ai-editor-title').innerText = `Chỉnh sửa: ${data.title || examId}`;
                modal.classList.remove('hidden');
                this.renderAIEditor();
                document.getElementById('ai-prompt-p1').value = meta.p1Prompt || "";
            },
            showPartIntro(partNum) {
                const container = document.getElementById('app-container');
                const tpl = document.getElementById('tpl-part-intro').content.cloneNode(true);
                document.getElementById('control-bar').classList.add('hidden');
                const config = {1:{icon:'fa-headphones',title:'Phần 1: Nghe nhắc lại',desc:'Nghe 10 câu. Nhắc lại sau tiếng bíp.'},2:{icon:'fa-image',title:'Phần 2: Mô tả tranh',desc:'Xem 2 bức tranh. Mô tả nội dung trong 2 phút.'},3:{icon:'fa-comments',title:'Phần 3: Trả lời câu hỏi',desc:'Trả lời 2 câu hỏi nghị luận (2 phút/câu).'}};
                tpl.querySelector('.part-icon').className = `part-icon fa-solid ${config[partNum].icon}`;
                tpl.querySelector('.part-title').innerText = config[partNum].title;
                tpl.querySelector('.part-desc').innerText = config[partNum].desc;
                tpl.querySelector('.btn-start-part').onclick = () => { if(partNum===1)this.startPart1(); else if(partNum===2)this.startPart2(); else if(partNum===3)this.startPart3(); };
                container.innerHTML = ''; container.appendChild(tpl);
            },
            markExamComplete(examId) {
                this.state.completedExams.add(examId);
                localStorage.setItem('hskk_completed_exams', JSON.stringify([...this.state.completedExams]));
            },
            
            // --- NEW BATCH GRADING FEATURE ---
            async gradeAll() {
                const buttons = Array.from(document.querySelectorAll('.btn-grade-item:not(.hidden)'));
                if (buttons.length === 0) return alert("Đã chấm hết hoặc không có bài để chấm!");

                const btnGradeAll = document.getElementById('btn-grade-all');
                if(btnGradeAll) {
                    btnGradeAll.disabled = true;
                    btnGradeAll.classList.add('opacity-75', 'cursor-not-allowed');
                }

                for (let i = 0; i < buttons.length; i++) {
                    const btn = buttons[i];
                    if(btnGradeAll) btnGradeAll.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Đang chấm ${i+1}/${buttons.length}...`;
                    const uuid = btn.dataset.uuid;
                    btn.closest('.bg-white').scrollIntoView({behavior: "smooth", block: "center"});
                    await this.gradeItem(uuid, btn);
                    await new Promise(r => setTimeout(r, 1000));
                }

                if(btnGradeAll) {
                    btnGradeAll.innerHTML = '<i class="fa-solid fa-check-double mr-2"></i> Đã chấm xong';
                    btnGradeAll.classList.replace('bg-purple-600', 'bg-green-600');
                    btnGradeAll.classList.replace('hover:bg-purple-700', 'hover:bg-green-700');
                }
                alert("Đã hoàn tất chấm điểm tất cả!");
            },

            // --- MISSING FUNCTIONS RESTORED ---
            async openAICreator() {
                const modal = document.getElementById('ai-modal');
                this.state.editingExamId = null;
                document.getElementById('ai-editor-title').innerText = 'AI Exam Architect';
                modal.classList.remove('hidden'); document.getElementById('ai-loading-view').classList.remove('hidden'); document.getElementById('ai-editor-view').classList.add('hidden');
                try { await this.initAIExam(); document.getElementById('ai-loading-view').classList.add('hidden'); document.getElementById('ai-editor-view').classList.remove('hidden'); } catch (e) { console.error(e); }
            },
            closeAIModal() { document.getElementById('ai-modal').classList.add('hidden'); },
            async initAIExam() {
                const p1 = await AI_SERVICE.generateP1("Cuộc sống hàng ngày");
                this.state.tempAIExam = { p1: p1, p2: [{img:"https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?w=600", userPrompt: "meeting", text1:"Đang tải...", req:""}, {img:"https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?w=600", userPrompt: "reading", text1:"Đang tải...", req:""}], p3: [{q:"你觉得学外语重要吗？", a:"Đang tải...", req:""}, {q:"介绍一下你的家乡。", a:"Đang tải...", req:""}] };
                this.renderAIEditor(); this.lazyLoadRest();
            },
            async lazyLoadRest() {
                for (let i = 0; i < 2; i++) { const t1 = await AI_SERVICE.generateP2Essay(this.state.tempAIExam.p2[i].userPrompt, 'roleplay', ''); this.state.tempAIExam.p2[i].text1 = t1; this.updateP2UI(i); }
                for (let i = 0; i < 2; i++) { const a = await AI_SERVICE.generateP3Essay(this.state.tempAIExam.p3[i].q, ''); this.state.tempAIExam.p3[i].a = a; this.updateP3UI(i); }
            },
            updateP2UI(i) {
                if(document.getElementById(`ai-input-p2-${i}-text1`)) {
                    const [h1, p1, m1] = this.state.tempAIExam.p2[i].text1.split('#');
                    document.getElementById(`ai-input-p2-${i}-text1`).value = h1||""; document.getElementById(`ai-input-p2-${i}-text1-p`).value = p1||""; document.getElementById(`ai-input-p2-${i}-text1-m`).value = m1||"";
                }
            },
            updateP3UI(i) {
                if(document.getElementById(`ai-input-p3-a-${i}`)) {
                    const [h, p, m] = this.state.tempAIExam.p3[i].a.split('#');
                    document.getElementById(`ai-input-p3-a-${i}`).value = h||""; document.getElementById(`ai-input-p3-a-${i}-p`).value = p||""; document.getElementById(`ai-input-p3-a-${i}-m`).value = m||"";
                }
            },
            renderAIEditor() {
                const c = document.getElementById('ai-editor-content'); const d = this.state.tempAIExam;
                c.innerHTML = `
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><div class="flex justify-between items-center border-b pb-2 mb-3"><h4 class="font-bold text-blue-700">Phần 1: 10 Câu Nghe Nhắc Lại</h4><div class="flex gap-2"><input type="text" id="ai-prompt-p1" placeholder="VD: chủ đề công việc..." class="text-xs border rounded p-1.5 w-48"><button onclick="App.regenP1()" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded font-semibold text-gray-700"><i class="fa-solid fa-rotate mr-1"></i>Tạo lại (AI)</button></div></div><div class="relative"><textarea id="ai-input-p1" class="w-full h-40 p-3 border rounded text-sm text-gray-700 font-mono focus:ring-2 focus:ring-blue-300 outline-none resize-none" spellcheck="false">${d.p1.join('\n')}</textarea><div id="p1-loader" class="absolute inset-0 bg-white/80 hidden flex items-center justify-center"><div class="loader"></div></div></div></div>
                    <div class="space-y-4">${d.p2.map((item, i) => `<div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 relative overflow-hidden group"><h4 class="font-bold text-blue-700 mb-3 border-b pb-2">Phần 2 - Hình ${i+1}</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="col-span-1 flex flex-col"><div class="mb-2 relative"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 block">Prompt Ảnh</label><div class="flex gap-1 mb-2"><input type="text" id="ai-prompt-p2-${i}" value="${item.userPrompt||''}" placeholder="Mô tả ảnh..." class="flex-1 text-xs border rounded p-2 focus:ring-2 focus:ring-purple-300 outline-none"><button onclick="App.regenP2(${i}, true)" class="bg-purple-600 text-white px-3 rounded-lg text-xs font-bold shadow hover:bg-purple-700 transition flex items-center justify-center"><i class="fa-solid fa-wand-magic-sparkles"></i></button></div><label class="text-[10px] font-bold text-blue-500 uppercase tracking-wider mb-1 block">Yêu cầu Văn mẫu</label><div class="flex gap-1"><input type="text" id="ai-req-p2-${i}" value="${item.req||''}" placeholder="VD: giọng văn vui vẻ..." class="flex-1 text-xs border border-blue-200 rounded p-2 focus:ring-2 focus:ring-blue-300 outline-none bg-blue-50"><button onclick="App.regenP2(${i}, false)" class="bg-blue-100 text-blue-700 px-3 rounded-lg text-xs font-bold shadow hover:bg-blue-200 transition"><i class="fa-solid fa-pen-nib"></i></button></div></div><div class="relative rounded-lg overflow-hidden border border-gray-200 bg-gray-100 flex-1 min-h-[160px]"><img src="${item.img}" id="ai-img-preview-${i}" class="w-full h-full object-cover absolute inset-0"><div id="ai-img-loader-${i}" class="absolute inset-0 bg-white/90 hidden flex flex-col items-center justify-center z-10"><div class="loader"></div></div></div></div><div class="col-span-2 space-y-4 relative"><div id="ai-text-loader-${i}" class="absolute inset-0 bg-white/80 hidden z-20 flex items-center justify-center"><div class="loader"></div></div><div class="bg-gray-50 p-3 rounded-lg border border-gray-200"><label class="text-xs font-bold text-blue-600 mb-2 block">Văn mẫu AI</label><textarea id="ai-input-p2-${i}-text1" class="w-full h-20 p-2 border rounded text-xs outline-none focus:border-blue-500 resize-none mb-1 font-medium text-gray-800" placeholder="Chữ Hán">${item.text1.split('#')[0]||''}</textarea><div class="grid grid-cols-2 gap-2"><input id="ai-input-p2-${i}-text1-p" value="${item.text1.split('#')[1]||''}" class="w-full p-1.5 border rounded text-[10px] text-blue-600 font-mono bg-white" placeholder="Pinyin"><input id="ai-input-p2-${i}-text1-m" value="${item.text1.split('#')[2]||''}" class="w-full p-1.5 border rounded text-[10px] text-gray-600 italic bg-white" placeholder="Nghĩa"></div></div></div></div></div>`).join('')}</div>
                    <div class="space-y-4">${d.p3.map((item, i) => `<div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h4 class="font-bold text-blue-700 mb-3 border-b pb-2">Phần 3 - Câu ${i+1}</h4><div class="mb-4"><label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider block mb-1">Câu hỏi</label><input type="text" value="${item.q}" id="ai-input-p3-q-${i}" class="w-full p-3 border-2 border-blue-100 rounded-lg text-sm font-bold text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all mb-2" placeholder="Nhập câu hỏi..."><label class="text-[10px] font-bold text-purple-500 uppercase tracking-wider block mb-1">Yêu cầu bài mẫu</label><div class="flex gap-2"><input type="text" id="ai-req-p3-${i}" value="${item.req||''}" placeholder="VD: khoảng 300 từ..." class="flex-1 p-2 border-2 border-purple-100 rounded-lg text-xs bg-purple-50 focus:border-purple-500 outline-none"><button onclick="App.regenP3(${i})" class="bg-purple-500 text-white px-4 rounded-lg text-xs font-bold shadow hover:bg-purple-600 transition">Tạo câu trả lời</button></div></div><div class="bg-blue-50 p-4 rounded-xl border border-blue-100 relative"><div id="ai-p3-loader-${i}" class="absolute inset-0 bg-white/80 hidden z-20 flex items-center justify-center rounded-xl"><div class="loader"></div></div><textarea id="ai-input-p3-a-${i}" class="w-full h-32 p-3 border rounded-lg text-xs leading-relaxed text-gray-800 outline-none focus:border-blue-500 resize-none mb-2 shadow-inner" placeholder="Chữ Hán">${item.a.split('#')[0]||''}</textarea><div class="space-y-2"><input id="ai-input-p3-a-${i}-p" value="${item.a.split('#')[1]||''}" class="w-full p-2 border rounded text-xs text-blue-600 font-mono bg-white shadow-sm" placeholder="Pinyin"><input id="ai-input-p3-a-${i}-m" value="${item.a.split('#')[2]||''}" class="w-full p-2 border rounded text-xs text-gray-600 italic bg-white shadow-sm" placeholder="Nghĩa"></div></div></div>`).join('')}</div>`;
            },
            async regenP1() { document.getElementById('p1-loader').classList.remove('hidden'); const p = document.getElementById('ai-prompt-p1').value; const res = await AI_SERVICE.generateP1(p); this.state.tempAIExam.p1 = res; document.getElementById('ai-input-p1').value = res.join('\n'); document.getElementById('p1-loader').classList.add('hidden'); },
            async regenP2(i, img) { 
                if(img) { document.getElementById(`ai-img-loader-${i}`).classList.remove('hidden'); const p = document.getElementById(`ai-prompt-p2-${i}`).value; const res = await AI_SERVICE.generateImage(p); this.state.tempAIExam.p2[i].img = res; document.getElementById(`ai-img-preview-${i}`).src = res; document.getElementById(`ai-img-loader-${i}`).classList.add('hidden'); }
                document.getElementById(`ai-text-loader-${i}`).classList.remove('hidden'); const req = document.getElementById(`ai-req-p2-${i}`).value; const t1 = await AI_SERVICE.generateP2Essay(document.getElementById(`ai-prompt-p2-${i}`).value, 'roleplay', req); this.state.tempAIExam.p2[i].text1 = t1; this.updateP2UI(i); document.getElementById(`ai-text-loader-${i}`).classList.add('hidden');
            },
            async regenP3(i) { document.getElementById(`ai-p3-loader-${i}`).classList.remove('hidden'); const q = document.getElementById(`ai-input-p3-q-${i}`).value; const req = document.getElementById(`ai-req-p3-${i}`).value; const a = await AI_SERVICE.generateP3Essay(q, req); this.state.tempAIExam.p3[i].a = a; this.updateP3UI(i); document.getElementById(`ai-p3-loader-${i}`).classList.add('hidden'); },
            saveAIExam() {
                const id = this.state.editingExamId || `ai_${Date.now()}`;
                const p1 = document.getElementById('ai-input-p1').value;
                const p2 = [0,1].map(i => ({ img: this.state.tempAIExam.p2[i].img, txt: [document.getElementById(`ai-input-p2-${i}-text1`).value, document.getElementById(`ai-input-p2-${i}-text1-p`).value, document.getElementById(`ai-input-p2-${i}-text1-m`).value].join('#') }));
                const p3 = [0,1].map(i => ({ q: document.getElementById(`ai-input-p3-q-${i}`).value, a: [document.getElementById(`ai-input-p3-a-${i}`).value, document.getElementById(`ai-input-p3-a-${i}-p`).value, document.getElementById(`ai-input-p3-a-${i}-m`).value].join('#') }));
                const meta = { p1Prompt: document.getElementById('ai-prompt-p1').value, p2: [0,1].map(i=>({prompt: document.getElementById(`ai-prompt-p2-${i}`).value, req: document.getElementById(`ai-req-p2-${i}`).value})), p3: [0,1].map(i=>({req: document.getElementById(`ai-req-p3-${i}`).value})) };
                
                let title = `Bài thi AI ${new Date().toLocaleDateString('vi-VN')}`;
                if(this.state.editingExamId) { const old = MockFileSystem.getFullExamData(id); if(old && old.title) title = old.title; }

                MockFileSystem.addExam(id, {
                    "title": title, "p1.txt": p1, "metadata.json": JSON.stringify(meta),
                    "img1.png": p2[0].img, "P2_1.txt": p2[0].txt, "img2.png": p2[1].img, "P2_2.txt": p2[1].txt,
                    "p3_1.txt": `${p3[0].q}#${p3[0].a}`, "p3_2.txt": `${p3[1].q}#${p3[1].a}`
                });
                this.state.editingExamId = null; this.closeAIModal(); this.init();
            },

            renderDashboard() {
                const container = document.getElementById('app-container');
                const tpl = document.getElementById('tpl-dashboard').content.cloneNode(true);
                const list = tpl.querySelector('#exam-list');
                document.getElementById('control-bar').classList.add('hidden');
                
                if (this.state.isExternal) { const createCard = list.querySelector('#create-new-card'); if (createCard) createCard.remove(); }
                
                const allExams = MockFileSystem.getExamSets();
                const completed = allExams.filter(id => this.state.completedExams.has(id));
                const uncompleted = allExams.filter(id => !this.state.completedExams.has(id));
                const sortedExams = [...uncompleted, ...completed];
                
                sortedExams.forEach(examId => {
                    const card = document.createElement('div');
                    const isCompleted = this.state.completedExams.has(examId);
                    const bgClass = isCompleted ? "bg-green-50 border-green-200" : "bg-white border-transparent";
                    card.className = `${bgClass} p-6 rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer border hover:border-blue-500 relative overflow-hidden group flex flex-col`;
                    const isAI = examId.includes('ai_');
                    const examData = MockFileSystem.getFullExamData(examId);
                    let titleDisplay = examData.title;
                    if (!titleDisplay) titleDisplay = isAI ? `Đề AI: ${new Date(parseInt(examId.split('_')[2]||0)).toLocaleString('vi-VN')}` : `${examId}`;
                    const editActions = !this.state.isExternal ? `<div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="App.editExamContent('${examId}', event)" class="w-7 h-7 rounded-full bg-emerald-100 hover:bg-emerald-200 text-emerald-600 flex items-center justify-center transition" title="Sửa nội dung"><i class="fa-solid fa-file-pen text-xs"></i></button><button onclick="App.openEditModal('${examId}', event)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-blue-100 text-gray-500 hover:text-blue-600 flex items-center justify-center transition" title="Sửa tên/ID"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="App.confirmDelete('${examId}', event)" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-600 flex items-center justify-center transition" title="Xóa đề"><i class="fa-solid fa-trash text-xs"></i></button></div>` : `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">Read-only</span>`;
                    const completedBadge = isCompleted ? `<div class="absolute top-0 right-0 bg-green-500 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold"><i class="fa-solid fa-check mr-1"></i>Đã làm</div>` : '';
                    card.innerHTML = `${completedBadge}<div class="flex justify-between items-start mb-2"><div class="flex items-center gap-3"><div class="w-10 h-10 ${isCompleted ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-600'} rounded-lg flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors"><i class="fa-solid fa-file-contract"></i></div><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">HSKK Exam</span></div>${editActions}</div><h3 class="text-lg font-bold text-gray-800 capitalize mb-1 truncate pr-4" title="${titleDisplay}">${titleDisplay}</h3><p class="text-xs text-gray-400 mb-4 font-mono">ID: ${examId}</p><div class="grid grid-cols-4 gap-2 mt-auto pt-4 border-t border-gray-100 mb-4"><button onclick="App.exportWord('${examId}', event)" class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-blue-50 text-blue-600 transition"><i class="fa-solid fa-file-word text-lg mb-1"></i><span class="text-[10px] font-bold">Word</span></button><button onclick="App.exportTxt('${examId}', event)" class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-gray-100 text-gray-600 transition"><i class="fa-solid fa-file-lines text-lg mb-1"></i><span class="text-[10px] font-bold">TXT</span></button><button onclick="App.exportJson('${examId}', event)" class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-amber-50 text-amber-600 transition"><i class="fa-solid fa-code text-lg mb-1"></i><span class="text-[10px] font-bold">JSON</span></button><button onclick="App.printExam('${examId}', event)" class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-emerald-50 text-emerald-600 transition"><i class="fa-solid fa-print text-lg mb-1"></i><span class="text-[10px] font-bold">Print</span></button></div><div class="w-full py-2 ${isCompleted ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white text-center rounded-lg font-bold text-sm shadow opacity-0 group-hover:opacity-100 transition-opacity">${isCompleted ? 'Làm lại bài' : 'Làm bài thi'} <i class="fa-solid fa-play ml-1"></i></div>`;
                    card.onclick = (e) => { if(e.target.closest('button')) return; this.resetExamState(); this.loadExamData(examId); this.showPartIntro(1); };
                    list.appendChild(card);
                });
                container.innerHTML = ''; container.appendChild(tpl);
            },
        };
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>